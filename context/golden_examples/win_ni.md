# Golden Example — Data Contract: WIN NI

> Это эталонный пример хорошо заполненного контракта. Используй как ориентир по структуре, уровню конкретики и стилю.

## Статус
Approved

## Определение
**WIN NI** — New Income (NI) от **новых клиентов (Клиент = Юрлицо)**, зафиксированное в момент **оплаты первого инвойса** в отчётном периоде.

Уточнения:
- **Новый клиент**: юридическое лицо, у которого **не было оплаченных инвойсов** до начала периода.
- Если клиент подписал договор, но не оплатил инвойс — в WIN NI **не попадает**.

## Формула
Человеческая: сумма NI по всем первым оплатам инвойса новыми юрлицами в периоде.

Псевдо‑SQL:
```sql
SELECT
  SUM(i.amount) AS win_ni
FROM invoices i
JOIN dim_customer c ON c.customer_id = i.customer_id
WHERE
  i.is_paid = true
  AND i.paid_at >= :period_start
  AND i.paid_at <  :period_end
  AND i.is_first_paid_invoice_for_customer = true
  AND i.income_type = 'NI'
  AND c.customer_type = 'legal_entity'
;
```

## Источник данных
- Billing/Finance: invoices, payments
- CRM: сделки/контракты (как справочный контекст)
- dim_customer: единая сущность клиента

## Включает
- Первые оплаты новых клиентов
- Только NI (исключая REC)

## Исключения
- Повторные оплаты существующих клиентов (REC)
- Бартер/взаимозачёт, если не отражён в Billing как оплата
- Возвраты: если инвойс оплачен и затем полностью возвращён в периоде — требуется правило (см. «Известные проблемы»)

## Гранулярность
- Единица: инвойс (первый платёж клиента)
- Период: квартал (по paid_at)
- Обновление: ежедневно

## Ответственный за данные
- Billing/Finance: @finance_lead
- dim_customer: @dd_lead

## Ответственный за расчёт
- Analytics & Data: @dd_lead

## Связь с Extra Time
WIN NI → New Clients → MAU → Extra Time

Интерпретация: рост WIN NI означает рост новых платящих юрлиц → рост базы клиентов → рост MAU → рост Extra Time.

## Потребители
- CEO board
- Finance
- Sales (как факт, не как pipeline)

## Состояние данных
- Billing: источник правды по оплатам (доверяем)
- CRM: может расходиться по датам подписания/статусам, поэтому не используем как триггер фиксации

## Известные проблемы
- Разные трактовки момента фиксации (подписание vs оплата)
- Частичные оплаты / рассрочки: нужно правило (что считаем «первой оплатой»)
- Возвраты/чарджбеки: нужен механизм корректировок

## Связанные контракты
- dim_customer
- NI_REC_split
- win_signed (если заводим отдельную метрику для pipeline)

## Согласовано
@finance_lead — YYYY-MM-DD
@sales_lead — YYYY-MM-DD
@dd_lead — YYYY-MM-DD

## История изменений
YYYY-MM-DD — создан эталонный пример
